## Маршрутизация на основе политик (PBR) и IP SLA



#### Цель:

Настроить политику маршрутизации в офисе Чокурдах
Распределить трафик между 2 линками

#### Описание/Пошаговая инструкция выполнения домашнего задания:

В этой самостоятельной работе мы:

1. Распределим трафик для линков R28. Для сетей 100.1.30.0/24 и 100.1.31.0/24 назначим основным выходом в интернет с R28 через R26, за исключением обращения к сети 100.1.0.0/16, которые направим через R25. 

2. Настроим отслеживание линков е0/0 и е0/1 на роутере R28, чтобы при отключении одного из линков, весь трафик уходил по резервному с помощью IP SLA.

3. Настроим маршрут по умолчанию для роутера R27.

   

   ### Политики PBR:

   В этой части мы выполним первое и третье задания.

   Для распределения трафика на портах R28, мы создадим acl-лист для трафика, который будем выделять и направлять с R28 на R25, затем создадим маршрутную карту, в которой назначим принудительно перенаправлять трафик на роутер R25. Затем активируем правило маршрутной карты на sub-интерфейсах e0/2.30 и е0/2.31.



![image](https://github.com/SalminKHV/OTUS/assets/130359715/26b88f01-c778-4a4e-a68c-a389e4688a73)



![image](https://github.com/SalminKHV/OTUS/assets/130359715/d337e0b1-97db-4afa-8628-471a91ac555e)

Пропишем маршрут по умолчанию через роутер R26 и маршруты до соседних looback-адресов на маршрутизаторах.

![image](https://github.com/SalminKHV/OTUS/assets/130359715/f3e348f2-dbc1-455e-9e64-6c1759429350)



На соседних маршрутизаторах тоже настроим статическую маршрутизацию к соседним сетям.

На R25 пропишем кратчайший маршрут к R28 и сети, находящиеся за роутером, через порт е0/3 (next-hop100.15.20.3/31) :

![image](https://github.com/SalminKHV/OTUS/assets/130359715/3f581e37-35db-41e0-becf-9d26d5a6a12e)



на R26:

![image](https://github.com/SalminKHV/OTUS/assets/130359715/111432b0-824b-4ee9-8712-41c70b9613f4)



На R27 настроим маршрут по умолчанию через роутер R25 (100.15.20.4/31):

![image](https://github.com/SalminKHV/OTUS/assets/130359715/421162e7-0b8b-479f-b397-e46d411654f9)

Проверим работоспособность нашей настройки, запустив пинг из подсети 100.1.30.0/24 с коммутатора SW29:

![image](https://github.com/SalminKHV/OTUS/assets/130359715/a52ea0fb-deb8-4c06-866e-648f02a0b40b)

мы можем видеть, что пинги прошли по нужному порту, а именно через роутер R28, поступив на sub-интерфейс е0/2.30 отработала политика MY_PBR,  трафик направился на порт R28 е0/1 дошел до R27 и вернулся обратно на порт е0/1 роутера R28, и был перенаправлен на sub-интерфейс е0/2.30.

![image](https://github.com/SalminKHV/OTUS/assets/130359715/dfb4c21d-48e7-4be8-9751-19901da02019)



## IP SLA

Настроим отслеживание ip - адреса 100.15.20.0 на интерфейсе е0/0 и ip - адреса 100.15.20.2 е0/1 на роутере R28 с помощью IP SLA, чтобы при отключении одного из линков, весь трафик уходил по резервному. Такое правило мы создадим для сетей 100.1.30.0/24, 100.1.31.0/24 (чтобы при доступности R25, трафик к сети 100.1.0.0/16 направлялся через R25, а при его недоступности через R26) и для маршрута по умолчанию для R28, который мы направляем через R26(когда он доступен) и через R25(когда R26 не доступен). И также настроим правила отслеживания линков на R25, чтобы при пропадании связности с R28 по интерфейсу е0/3, трафик для сетей 100.1.30.0/24 и 100.1.31.0/24 перенаправлялся через роутер R26.

Для этого на роутре R28 создадим правила, по которым будем отслеживать доступность порта е0/3 R25 и  е0/1 на R26. 

![image](https://github.com/SalminKHV/OTUS/assets/130359715/98204a4c-8bda-4494-9dee-81a15d3933d0)

track 1 ip sla 1 reachability  

 delay down 30 up 30  

track 2 ip sla 2 reachability  

 delay down 30 up 30  

Настроим смену состояния трека через 30 секунд после первого отсутствующего Echo-ответа.

Затем пропишем маршруты по умолчанию с меньшей метрикой с отслеживанием трека 2 (роутер R26) и с большей метрикой без отслеживания трека через роутер R25.

![image](https://github.com/SalminKHV/OTUS/assets/130359715/8110e32c-c523-46ca-97c2-b8d2a0e111ac)



Добавим правило для маршрутной карты My_PBR c метрикой 10. Мы также будем отслеживать трафик согласно acсess- листа Vlan30, который выбирает трафик от подсетей 100.1.30.0/24 и 100.1.31.0/24 направляющийся к подсети 100.1.0.0/16, а наше правило будет направлять этот трафик через R25, если он доступен или через R26 если не доступен R25 и при этом доступен R26. Если не будут оба доступны, то Будет применять следующее правило маршрутной карты с более высокой метрикой.

![image](https://github.com/SalminKHV/OTUS/assets/130359715/63a3dcfc-504b-4c6d-a8e7-ebf54ee25126)

![image](https://github.com/SalminKHV/OTUS/assets/130359715/ec497e70-ec61-44f5-9f4c-7f678ba9457d)

Посмотрим настройки на R25: 

![image](https://github.com/SalminKHV/OTUS/assets/130359715/14fc388e-d976-4206-96ce-3ae0919115a1)

Здесь мы настроили 1 трек и 1 Правило SLA 1, которое отслеживает доступность интерфейса е0/1 R28, если интерфейс доступен, трафик для сетей 100.1.30.0/24 и 100.1.31.0/24 направляется через него, а если нет, то через роутер R26.

На R26 добавили несколько маршрутов к подсетям, с которыми взаимодействуем в рамках лабораторной работы :

![image](https://github.com/SalminKHV/OTUS/assets/130359715/86a07829-bbec-4bd2-8261-06d425275b2c)



![image](https://github.com/SalminKHV/OTUS/assets/130359715/7b9cd381-5678-402b-b4b9-1cfacc1dea51)

Если открыть Wireshark, можно посмотреть как работает отслеживание связности на E0/0 (слева) и E0/1 (спарава) на R28:

![image](https://github.com/SalminKHV/OTUS/assets/130359715/e0f34370-bdd3-4c02-8711-d8b20dc1c8d6)
